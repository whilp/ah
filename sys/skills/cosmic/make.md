# Makefile Generation

`cosmic --make` scans a directory for `.tl` files and generates a self-contained Makefile with targets for compiling, type-checking, format-checking, testing, and reporting.

## Quick Start

```bash
cosmic --make              # print generated Makefile to stdout
cosmic --make .            # generate and pipe to make (default target)
cosmic --make . test       # generate and run the test target
cosmic --make src ci       # scan src/, run ci target
```

when called without a directory argument, `cosmic --make` prints the Makefile to stdout so you can inspect or redirect it. with a directory argument, it pipes directly to `make -f -`.

## Generated Makefile

for a project with `app.tl`, `lib.tl`, `app_test.tl`, and `app_example.tl`, the output looks like:

```makefile
# Generated by cosmic --make
# https://github.com/whilp/cosmic

-include cosmic.mk

COSMIC ?= cosmic
SRC_DIR ?= .
BUILD_DIR ?= o

sources := \
  app.tl \
  lib.tl

tests := \
  app_test.tl

examples := \
  app_example.tl

lua_files := $(patsubst %.tl,$(BUILD_DIR)/%.lua,$(sources))
test_results := $(patsubst %.tl,$(BUILD_DIR)/%.tl.test.got,$(tests))

.PHONY: all build check format test ci clean

all: build

## Compile .tl files to .lua
build: $(lua_files)

$(BUILD_DIR)/%.lua: %.tl
	@mkdir -p $(@D)
	$(COSMIC) --compile $< > $@

## Type-check all source and test files
check: $(sources) $(tests) $(examples)
	@for f in $^; do \
	  echo "check $$f"; \
	  $(COSMIC) --check-types $$f || exit 1; \
	done

## Check formatting on all files
format: $(sources) $(tests) $(examples)
	@for f in $^; do \
	  echo "format $$f"; \
	  $(COSMIC) --check-format $$f || exit 1; \
	done

## Run tests and report results
test: $(test_results)
	$(COSMIC) --report $(test_results)

$(BUILD_DIR)/%.tl.test.got: %.tl
	@mkdir -p $(@D)
	$(COSMIC) --test $(BUILD_DIR)/$<.test $(COSMIC) $<

## Run format + check + test
ci: format check test

## Remove build artifacts
clean:
	rm -rf $(BUILD_DIR)
```

## How It Works

1. **scan**: `cosmic --make` walks the directory for `*.tl` files and classifies them:
   - `*_test.tl` files go into `tests`
   - `*_example.tl` files go into `examples`
   - everything else goes into `sources`

2. **generate**: it emits a Makefile with pattern rules that invoke `cosmic` CLI commands (`--compile`, `--check-types`, `--check-format`, `--test`, `--report`).

3. **run** (optional): when given a directory argument, it pipes the Makefile to `make -f -`, optionally with a specific target.

## Customization

the generated Makefile includes `-include cosmic.mk` at the top. create a `cosmic.mk` file to override variables or add project-specific rules:

```makefile
# cosmic.mk — project-local overrides
COSMIC = ./bin/cosmic
BUILD_DIR = build
```

the three configurable variables are:
- `COSMIC` — path to the cosmic binary (default: `cosmic`)
- `SRC_DIR` — source directory (default: `.`)
- `BUILD_DIR` — output directory (default: `o`)

## Targets

| target   | description                                  |
|----------|----------------------------------------------|
| `all`    | default: runs `build`                        |
| `build`  | compile `.tl` to `.lua` in `BUILD_DIR`       |
| `check`  | type-check all sources, tests, and examples  |
| `format` | check formatting on all files                |
| `test`   | run tests and report results                 |
| `ci`     | run `format` + `check` + `test`              |
| `clean`  | remove `BUILD_DIR`                           |

## Saving the Makefile

to commit a generated Makefile to your repo:

```bash
cosmic --make > Makefile
```

then run targets directly with `make`:

```bash
make check
make test
make ci
```
