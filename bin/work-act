#!/usr/bin/env cosmic

local fs = require("cosmic.fs")
local json = require("cosmic.json")
local proc = require("cosmic.proc")
local getopt = require("cosmic.getopt")

local M = {}

local function usage()
  io.stderr:write("usage: work-act --issue-url <url>\n")
end

local function read_file(path)
  local f = io.open(path, "r")
  if not f then return nil end
  local content = f:read("*a")
  f:close()
  return content
end

local function write_file(path, content)
  local f = io.open(path, "w")
  if not f then return false end
  f:write(content)
  f:close()
  return true
end

local function tee(path, line)
  print(line)
  local f = io.open(path, "a")
  if f then
    f:write(line .. "\n")
    f:close()
  end
end

function M.main(args)
  local issue_url

  local longopts = {
    {name = "help", has_arg = "none", short = "h"},
    {name = "issue-url", has_arg = "required"},
  }

  local parser = getopt.new(args, "h", longopts)

  while true do
    local opt, optarg = parser:next()
    if not opt then break end

    if opt == "h" or opt == "help" then
      usage()
      return 0
    elseif opt == "issue-url" then
      issue_url = optarg
    elseif opt == "?" then
      usage()
      return 1
    end
  end

  if not issue_url then
    usage()
    return 1
  end

  fs.makedirs("o/work/act")

  local act_md = "o/work/act/act.md"
  write_file(act_md, "")

  tee(act_md, "=== DRY RUN ===")

  local actions_content = read_file("o/work/check/actions.json")
  if not actions_content then
    tee(act_md, "No actions.json found")
    return 0
  end

  local ok, actions_data = pcall(json.decode, actions_content)
  if not ok or type(actions_data) ~= "table" then
    tee(act_md, "Failed to parse actions.json")
    return 1
  end

  local verdict = actions_data.verdict or "unknown"
  tee(act_md, "Verdict: " .. verdict)
  tee(act_md, "")
  tee(act_md, "## Actions")

  local actions = actions_data.actions or {}
  for _, action in ipairs(actions) do
    local action_type = action.action or "unknown"
    tee(act_md, "Would execute: " .. action_type)
    local f = io.open(act_md, "a")
    if f then
      f:write("  Payload: " .. json.encode(action) .. "\n")
      f:close()
    end
  end

  write_file("o/work/act/results.json", json.encode({
    verdict = verdict,
    dry_run = true
  }) .. "\n")

  return 0
end

if proc.is_main() then
  os.exit(M.main(arg) or 0)
end

return M
