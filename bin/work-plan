#!/usr/bin/env cosmic

local spawn = require("cosmic.child")
local fs = require("cosmic.fs")
local env = require("cosmic.env")
local proc = require("cosmic.proc")
local getopt = require("cosmic.getopt")

local M = {}

local function usage()
  io.stderr:write("usage: work-plan --title <title> --body <body> --number <number>\n")
end

local function read_file(path)
  local f = io.open(path, "r")
  if not f then return nil end
  local content = f:read("*a")
  f:close()
  return content
end

local function file_exists(path)
  local f = io.open(path, "r")
  if f then f:close() return true end
  return false
end

function M.main(args)
  local title, body, number

  local longopts = {
    {name = "help", has_arg = "none", short = "h"},
    {name = "title", has_arg = "required", short = "t"},
    {name = "body", has_arg = "required", short = "b"},
    {name = "number", has_arg = "required", short = "n"},
  }

  local parser = getopt.new(args, "ht:b:n:", longopts)

  while true do
    local opt, optarg = parser:next()
    if not opt then break end

    if opt == "h" or opt == "help" then
      usage()
      return 0
    elseif opt == "t" or opt == "title" then
      title = optarg
    elseif opt == "b" or opt == "body" then
      body = optarg
    elseif opt == "n" or opt == "number" then
      number = optarg
    elseif opt == "?" then
      usage()
      return 1
    end
  end

  if not title or not body or not number then
    usage()
    return 1
  end

  fs.makedirs("o/work/plan")

  local prompt = read_file("sys/work/plan.md")
  if not prompt then
    io.stderr:write("error: could not read sys/work/plan.md\n")
    return 1
  end

  prompt = prompt:gsub("{title}", title)
  prompt = prompt:gsub("{body}", body)
  prompt = prompt:gsub("{issue_number}", number)

  local handle, err = spawn.spawn({
    "o/bin/ah", "-n", "--db", "o/work/plan/session.db", prompt
  }, {env = env.all()})

  if not handle then
    io.stderr:write("error: failed to spawn ah: " .. tostring(err) .. "\n")
    return 1
  end

  local ok, _, exit_str = handle:read()
  local exit_code = tonumber(exit_str) or 0

  if not ok or exit_code ~= 0 then
    io.stderr:write("error: ah exited with code " .. exit_code .. "\n")
    return 1
  end

  if not file_exists("o/work/plan/plan.md") then
    io.stderr:write("error: plan.md not created\n")
    return 1
  end

  return 0
end

if proc.is_main() then
  os.exit(M.main(arg) or 0)
end

return M
