#!/bin/bash
# Run plan phase: research issue and produce plan.md
set -euo pipefail

usage() { echo "usage: work-plan --title <title> --body <body> --number <number>" >&2; exit 1; }

title="" body="" number=""
while [[ $# -gt 0 ]]; do
  case $1 in
    --title) title="$2"; shift 2 ;;
    --body) body="$2"; shift 2 ;;
    --number) number="$2"; shift 2 ;;
    *) usage ;;
  esac
done

[[ -n "$title" && -n "$body" && -n "$number" ]] || usage

mkdir -p o/work/plan

prompt=$(cat sys/work/plan.md)
prompt="${prompt//\{title\}/$title}"
prompt="${prompt//\{body\}/$body}"
prompt="${prompt//\{issue_number\}/$number}"

o/bin/ah -n --db o/work/plan/session.db "$prompt"

# Verify output
test -f o/work/plan/plan.md
