#!/usr/bin/env cosmic

local spawn = require("cosmic.child")
local env = require("cosmic.env")
local proc = require("cosmic.proc")

local M = {}

local function read_file(path)
  local f = io.open(path, "r")
  if not f then return nil end
  local content = f:read("*a")
  f:close()
  return content
end

local function run(cmd)
  local handle, err = spawn.spawn(cmd, {env = env.all()})
  if not handle then return false end
  local ok, _, exit_str = handle:read()
  return ok and tonumber(exit_str) == 0
end

local function run_quiet(cmd)
  local handle = spawn.spawn(cmd, {env = env.all()})
  if not handle then return false, "" end
  local ok, stdout, exit_str = handle:read()
  return ok and tonumber(exit_str) == 0, stdout or ""
end

function M.main()
  local branch_content = read_file("o/work/do/branch.txt")
  if not branch_content then
    io.stderr:write("error: could not read o/work/do/branch.txt\n")
    return 1
  end

  local branch = branch_content:gsub("%s+$", "")

  -- Check if there are commits beyond main
  local has_parent = run({"git", "rev-parse", "--verify", "HEAD~1"})
  if not has_parent then
    return 0
  end

  -- Check if there are differences from main
  local same, _ = run_quiet({"git", "diff", "--quiet", "origin/main...HEAD"})
  if same then
    return 0
  end

  -- Push the branch
  run({"git", "push", "-u", "origin", "HEAD:" .. branch})

  return 0
end

if proc.is_main() then
  os.exit(M.main() or 0)
end

return M
