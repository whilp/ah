#!/bin/bash
# Run do phase: execute plan and create commits
# Requires: ISSUE_TITLE, ISSUE_NUMBER
# Expects: o/work/plan/plan.md from plan phase
set -euo pipefail

: "${ISSUE_TITLE:?required}"
: "${ISSUE_NUMBER:?required}"

mkdir -p o/work/do

plan_contents=$(cat o/work/plan/plan.md)

prompt=$(cat sys/work/do.md)
prompt="${prompt//\{title\}/$ISSUE_TITLE}"
prompt="${prompt//\{plan.md contents\}/$plan_contents}"

# Extract branch from plan or use default
branch=$(grep -oP 'Branch: \K.*' o/work/plan/plan.md || echo "work/$ISSUE_NUMBER")
prompt="${prompt//\{branch\}/$branch}"

o/bin/ah -n --db .ah/do.db "$prompt"

# Save branch name for other phases
echo "$branch" > o/work/do/branch.txt
